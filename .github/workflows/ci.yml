name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Build & Test Product Service
        run: |
          cd product-service
          mvn -B clean test

      - name: Build & Test Order Service
        run: |
          cd order-service
          mvn -B clean test

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            product-service/target/surefire-reports
            order-service/target/surefire-reports

  docker-build:
    name: Docker Build & Integration Test
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Build + start in one command so the containers use the freshly built images
      - name: Build and start services
        run: docker compose up -d --build

      # ---- DEBUG BLOCK (always prints) ----
      - name: Show compose status
        if: always()
        run: |
          docker compose ps -a || true

      - name: Show image IDs actually running
        if: always()
        run: |
          echo "=== product-service image ==="
          docker inspect product-service --format 'Image={{.Image}} Name={{.Name}}' || true
          echo "=== order-service image ==="
          docker inspect order-service --format 'Image={{.Image}} Name={{.Name}}' || true

      - name: Debug health + actuator + logs (product-service)
        if: always()
        run: |
          echo "=== product-service health (docker inspect) ==="
          docker inspect product-service --format '{{json .State.Health}}' || true
          echo "=== curl /actuator (inside container) ==="
          docker exec -i product-service sh -lc "curl -i http://localhost:8081/actuator || true"
          echo "=== curl /actuator/health (inside container) ==="
          docker exec -i product-service sh -lc "curl -i http://localhost:8081/actuator/health || true"
          echo "=== product-service logs (tail 200) ==="
          docker compose logs --no-color --tail=200 product-service || true

      - name: Debug health + actuator + logs (order-service)
        if: always()
        run: |
          echo "=== order-service health (docker inspect) ==="
          docker inspect order-service --format '{{json .State.Health}}' || true
          echo "=== curl /actuator/health (inside container) ==="
          docker exec -i order-service sh -lc "curl -i http://localhost:8082/actuator/health || true"
          echo "=== order-service logs (tail 200) ==="
          docker compose logs --no-color --tail=200 order-service || true

      - name: Wait for product-service to be healthy
        run: |
          for i in {1..30}; do
            STATUS=$(docker inspect -f '{{.State.Health.Status}}' product-service 2>/dev/null || echo "unknown")
            echo "product-service health: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "product-service is healthy"
              exit 0
            fi
            sleep 3
          done
          echo "product-service did not become healthy"
          exit 1

      - name: Wait for order-service to be healthy
        run: |
          for i in {1..30}; do
            STATUS=$(docker inspect -f '{{.State.Health.Status}}' order-service 2>/dev/null || echo "unknown")
            echo "order-service health: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "order-service is healthy"
              exit 0
            fi
            sleep 3
          done
          echo "order-service did not become healthy"
          exit 1

      - name: Integration Test - Product CRUD + Order flow
        run: |
          set -e

          echo "Health checks"
          curl -fsS http://localhost:8081/actuator/health
          curl -fsS http://localhost:8082/actuator/health

          echo "Create product Milk"
          CREATE_PRODUCT_RESPONSE=$(curl -fsS -X POST http://localhost:8081/api/products \
            -H "Content-Type: application/json" \
            -d '{"name":"Milk","price":4.99,"quantity":10}')
          echo "$CREATE_PRODUCT_RESPONSE"

          echo "List products"
          curl -fsS http://localhost:8081/api/products

          echo "Get product id=1 (adjust if your IDs differ)"
          curl -fsS http://localhost:8081/api/products/1

          echo "Create order (productId=1, quantity=2)"
          CREATE_ORDER_RESPONSE=$(curl -fsS -X POST http://localhost:8082/api/orders \
            -H "Content-Type: application/json" \
            -d '{"productId":1,"quantity":2}')
          echo "$CREATE_ORDER_RESPONSE"

          echo "List orders"
          curl -fsS http://localhost:8082/api/orders

          echo "Get order id=1"
          curl -fsS http://localhost:8082/api/orders/1

          echo "Insufficient quantity test (should fail)"
          set +e
          curl -fsS -X POST http://localhost:8082/api/orders \
            -H "Content-Type: application/json" \
            -d '{"productId":1,"quantity":999}'
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Expected failure for insufficient quantity, but request succeeded"
            exit 1
          else
            echo "Insufficient quantity request failed as expected"
          fi

      - name: Shut down containers
        if: always()
        run: docker compose down
