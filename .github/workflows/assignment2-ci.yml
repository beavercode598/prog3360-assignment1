name: Assignment 2 CI

on:
  push:
    branches: [ "assignment2-feature-flags" ]
  pull_request:
    branches: [ "assignment2-feature-flags" ]

jobs:

  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "maven"

      - name: Build & Test Product Service
        working-directory: product-service
        run: mvn -B clean test

      - name: Build & Test Order Service
        working-directory: order-service
        run: mvn -B clean test

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            product-service/target/surefire-reports
            order-service/target/surefire-reports


  unleash-integration:
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      # Start infrastructure (postgres + unleash only)
      - name: Start postgres + unleash
        run: docker compose up -d postgres unleash-server

      # Wait for Unleash to be healthy
      - name: Wait for Unleash health
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:4242/health >/dev/null; then
              echo "Unleash is healthy"
              exit 0
            fi
            echo "Waiting for Unleash... ($i/30)"
            sleep 2
          done
          echo "Unleash did not become healthy in time"
          exit 1

      # Initialize flags and backend token
      - name: Init Unleash flags
        run: |
          chmod +x scripts/ci-unleash-init.sh
          scripts/ci-unleash-init.sh

      # Ensure secret exists
      - name: Verify UNLEASH_API_TOKEN secret
        env:
          UNLEASH_API_TOKEN: ${{ secrets.UNLEASH_API_TOKEN }}
        run: |
          if [ -z "$UNLEASH_API_TOKEN" ]; then
            echo "UNLEASH_API_TOKEN is EMPTY"
            exit 1
          fi
          echo "UNLEASH_API_TOKEN present (length=${#UNLEASH_API_TOKEN})"

      
      - name: Create .env for docker compose
        env:
          UNLEASH_API_TOKEN: ${{ secrets.UNLEASH_API_TOKEN }}
        run: |
          cat > .env << EOF
          UNLEASH_API_URL=http://unleash-server:4242/api
          UNLEASH_API_TOKEN=${UNLEASH_API_TOKEN}
          EOF
          echo ".env created"

      # Start microservices
      - name: Start microservices
        run: docker compose up -d --build product-service order-service

      # Verify UNLEASH vars inside containers
      - name: Verify containers see UNLEASH vars
        run: |
          echo "---- product-service ----"
          docker exec product-service sh -lc 'printenv | grep UNLEASH_ || true'
          echo "---- order-service ----"
          docker exec order-service sh -lc 'printenv | grep UNLEASH_ || true'

      # Wait for services to be healthy
      - name: Wait for microservices health
        run: |
          for i in {1..30}; do
            P_OK=0
            O_OK=0

            if curl -fsS http://localhost:8081/actuator/health >/dev/null; then P_OK=1; fi
            if curl -fsS http://localhost:8082/actuator/health >/dev/null; then O_OK=1; fi

            if [ "$P_OK" -eq 1 ] && [ "$O_OK" -eq 1 ]; then
              echo "Both services are healthy"
              exit 0
            fi

            echo "Waiting for services... ($i/30)"
            sleep 2
          done

          echo "Services failed to become healthy"
          docker logs product-service || true
          docker logs order-service || true
          exit 1

      # Run integration tests
      - name: Run feature-flag integration tests
        run: |
          chmod +x scripts/ci-integration-tests.sh
          scripts/ci-integration-tests.sh

      # Always shut down
      - name: Shut down containers
        if: always()
        run: docker compose down -v